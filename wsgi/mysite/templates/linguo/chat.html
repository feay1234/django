{% extends 'linguo/base.html' %}
{% block content %}
<style type="text/css">

#content {
    top: 90px;
    right: 0;
    bottom: 0;
    overflow-y: hidden;
    max-width: 900px;
}
#messageContent {
    overflow: auto;
    height: 350px;
}




</style>
<div style="">
	<div id="chat_list"class="list-group col-md-3 visible-md visible-lg" style="margin-top:90px;">
		{% for i in userProfile.friends.all %}
			{% if i.name == talker %}
		  		<a href="#" class="list-group-item active talker" name="{{i}}">
			  		<span class="badge">14</span>
					{{i.name}}
			  	</a>
			{% else %}
    			<a href="#" class="list-group-item" name="{{i.name}}">
			  		<span class="badge">14</span>
					{{i.name}}
			  	</a>
			{% endif %}
	  	{% endfor %}
	</div>

	<div id="content" class="col-md-9" >
		<div id="messageContent" class="thumbnail">
			{% for i in message %}
		  	<div class="media thumbnail">
			  <a class="pull-left" href="#">
			    <img class="media-object" src="" style="height:50px; width:50px;">
			  </a>
			  	<div class="media-body">
				    <h4 class="media-heading">{{i.sender}}</h4>
				    <p>{{i.text}}</p>
				    <!-- {{i.datetime}} -->
				</div>
			</div>
			{% endfor %}
			
		</div>	
		<br>
		<div id="textInput">
			<textarea class="form-control" rows="3"></textarea>
		</div>

		
	</div>
</div>

<script type="text/javascript">

var objDiv = document.getElementById("messageContent");
objDiv.scrollTop = objDiv.scrollHeight;



(function poll(){
$.ajax({
    type: 'GET',
    url: '/linguo/get_new_message',
    success: function(data){       
        createMessage(data);
    },
    dataType: "json",
    complete: poll,
    timeout: 30000
})
})();






$("textarea").keyup(function (e) {
	// have to show text before save text to database if not success show re-send button to user.
	// at this postition, you can tell receiver that sender is typing. should do.
	text = $(this).val();
	if (e.keyCode == 13 && text.length > 0) {
		
	  	receiver = $('.talker').attr("name");
	  	$(this).val("")
	  
	  	$.get('/linguo/send_message',{'receiver':receiver, 'text':text}, function(data){
	  		createMessage(data);
	  	})
		
	  

	  
	}
});

function createMessage(data){
	for( var i = 0; i<data.length; i++){
		$("<div class='media thumbnail'>"+
			"<a class='pull-left'>"+
				"<img class='media-object' src='' style='height:50px; width:50px;'>"+
			"</a>"+
			"<div class='media-body'>"+
				"<h4 class='media-heading'>"+data[i].fields.sender+"</h4>"+
				"<p>"+data[i].fields.text+"</p>"+
			"</div>"+
			"</div>").appendTo($("#messageContent"));
		// var objDiv = document.getElementById("messageContent");s
		// objDiv.scrollTop = objDiv.scrollHeight;
	}
	objDiv.scrollTop = objDiv.scrollHeight;
	
}

//change NarBar
$(".selectedBar").attr("class", "navBar");
$(".chatBar").attr("class", "selectedBar active");



</script>

{% endblock %}
